<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRooms</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent: #3b82f6;
        }
        
        body {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        .message-container {
            height: calc(100vh - 220px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-secondary);
        }

        .message-container::-webkit-scrollbar {
            width: 8px;
        }

        .message-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .message-container::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 4px;
        }

        .message {
            animation: fadeInUp 0.3s ease;
        }

        .avatar {
            transition: transform 0.2s;
        }

        .avatar:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-md w-full mx-4 animate__animated animate__fadeInDown">
            <h2 class="text-2xl font-bold mb-6 text-center">Join Chat Room</h2>
            <input type="text" id="username" placeholder="Enter your username" 
                   class="w-full p-3 mb-4 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
            <button onclick="joinRoom()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-200">
                Join Room
            </button>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chatInterface" class="hidden container mx-auto px-4 py-8 max-w-6xl">
        <!-- Room Info -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold mb-2">Room: <span id="roomName" class="text-blue-400"></span></h1>
                <p class="text-gray-400">Share this link to invite others:</p>
                <div class="flex items-center mt-2">
                    <input type="text" id="roomLink" readonly 
                           class="bg-gray-700 px-4 py-2 rounded-l text-sm flex-grow">
                    <button onclick="copyLink()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-r transition duration-200">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="text-right">
                <button onclick="createNewRoom()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded font-bold mb-2 w-full transition duration-200">
                    Create New Room
                </button>
                <p id="userCount" class="text-gray-400 text-sm">
                    <i class="fas fa-users"></i> Online: 0
                </p>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div id="messages" class="message-container mb-6">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Message Input -->
            <div class="flex gap-4">
                <input type="text" id="messageInput" placeholder="Type your message..." 
                       class="flex-grow p-4 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none">
                <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 px-8 rounded-lg font-bold transition duration-200">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Initialize Firebase-like functionality with localStorage
        const db = {
            rooms: JSON.parse(localStorage.getItem('rooms')) || {},
            messages: JSON.parse(localStorage.getItem('messages')) || {},
            users: JSON.parse(localStorage.getItem('users')) || {}
        };

        let currentRoom = null;
        let currentUser = null;
        let isAdmin = false;

        // Configure toastr
        toastr.options = {
            closeButton: true,
            positionClass: "toast-bottom-right",
            timeOut: 3000
        };

        // Initialize room from URL
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            
            if (roomId && db.rooms[roomId]) {
                currentRoom = roomId;
                document.getElementById('roomName').textContent = db.rooms[roomId].name;
                document.getElementById('roomLink').value = window.location.href;
            } else if (!roomId) {
                createNewRoom();
            } else {
                toastr.error('Room not found!');
                createNewRoom();
            }
        }

        // Create new room
        function createNewRoom() {
            const roomId = Math.random().toString(36).substr(2, 9);
            const roomName = `Room ${Math.floor(Math.random() * 1000)}`;
            
            db.rooms[roomId] = {
                name: roomName,
                createdAt: new Date().toISOString(),
                admin: currentUser
            };
            
            db.messages[roomId] = [];
            saveToStorage();
            
            window.location.href = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
        }

        // Join room
        function joinRoom() {
            const username = document.getElementById('username').value.trim();
            if (username) {
                currentUser = username;
                if (db.rooms[currentRoom]?.admin === username) {
                    isAdmin = true;
                }
                
                // Generate random cat avatar
                if (!db.users[currentRoom]) db.users[currentRoom] = {};
                db.users[currentRoom][username] = {
                    avatar: `https://api.thecatapi.com/v1/images/search?size=small&timestamp=${new Date().getTime()}`,
                    joinedAt: new Date().toISOString()
                };
                
                saveToStorage();
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
                
                loadMessages();
                setupMessageListener();
                toastr.success(`Welcome to the chat, ${username}!`);
            }
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                const newMessage = {
                    id: Date.now(),
                    text: message,
                    user: currentUser,
                    timestamp: new Date().toISOString(),
                    avatar: db.users[currentRoom][currentUser].avatar
                };
                
                db.messages[currentRoom].push(newMessage);
                saveToStorage();
                input.value = '';
                renderMessage(newMessage);
                scrollToBottom();
            }
        }

        // Delete message (admin only)
        function deleteMessage(messageId) {
            if (isAdmin) {
                db.messages[currentRoom] = db.messages[currentRoom].filter(m => m.id !== messageId);
                saveToStorage();
                loadMessages();
                toastr.success('Message deleted');
            }
        }

        // Render single message
        function renderMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message flex items-start gap-4 mb-6 ${message.user === currentUser ? 'flex-row-reverse' : ''}`;
            
            messageDiv.innerHTML = `
                <img src="${message.avatar}" alt="${message.user}" 
                     class="avatar w-10 h-10 rounded-full object-cover">
                <div class="${message.user === currentUser ? 'text-right' : ''}">
                    <div class="flex items-center gap-2 mb-1 ${message.user === currentUser ? 'justify-end' : ''}">
                        <span class="font-bold text-blue-400">${message.user}</span>
                        <span class="text-xs text-gray-400">
                            ${new Date(message.timestamp).toLocaleTimeString()}
                        </span>
                        ${isAdmin ? `
                            <button onclick="deleteMessage(${message.id})" class="text-red-500 hover:text-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                    <div class="bg-gray-700 rounded-lg p-3 inline-block max-w-xl">
                        ${message.text}
                    </div>
                </div>
            `;
            
            document.getElementById('messages').appendChild(messageDiv);
        }

        // Load all messages
        function loadMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            db.messages[currentRoom].forEach(renderMessage);
            scrollToBottom();
            updateUserCount();
        }

        // Utility functions
        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function copyLink() {
            const linkInput = document.getElementById('roomLink');
            linkInput.select();
            document.execCommand('copy');
            toastr.success('Link copied to clipboard!');
        }

        function updateUserCount() {
            const count = Object.keys(db.users[currentRoom] || {}).length;
            document.getElementById('userCount').innerHTML = `<i class="fas fa-users"></i> Online: ${count}`;
        }

        function saveToStorage() {
            localStorage.setItem('rooms', JSON.stringify(db.rooms));
            localStorage.setItem('messages', JSON.stringify(db.messages));
            localStorage.setItem('users', JSON.stringify(db.users));
        }

        function setupMessageListener() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        }

        // Initialize app
        init();
    </script>
</body>
</html>
